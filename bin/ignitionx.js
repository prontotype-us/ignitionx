#!/usr/bin/env node
// Generated by CoffeeScript 1.6.3
(function() {
  var $name, $type, NGINX_CONF_DIR, TEMPLATE_DIR, argv, conf_filename, conf_rendered, conf_template, conf_template_filename, context, end_with_usage, fs, key, usages, val;

  fs = require('fs');

  argv = require('optimist').argv;

  NGINX_CONF_DIR = process.env.NGINX_CONF_DIR || '/etc/nginx';

  TEMPLATE_DIR = "" + __dirname + "/../templates";

  usages = {
    proxy: "<name> <port>",
    "static": "<name> <basedir>"
  };

  end_with_usage = function(type) {
    if (type == null) {
      console.log("Usage: ignitionx <type> <params...> [options...]");
      console.log("Types:");
      console.log("  proxy       NGINX reverse proxy at port <port>");
      console.log("  static      Static directory at <basedir>");
    } else {
      console.log("Usage: ignitionx " + type + " " + usages[type] + " [options...]");
    }
    console.log("Options:");
    console.log("  -o          Output to default nginx configuration path");
    console.log("  -o <file>   Output to <file>");
    console.log("  -v          Verbose output");
    return process.exit();
  };

  if (argv._.length < 2) {
    end_with_usage();
  }

  $type = argv._[0];

  $name = argv._[1];

  context = {
    $type: $type,
    $name: $name
  };

  if ($type === 'proxy') {
    context['$port'] = argv._[2];
    if (context['$port'] == null) {
      end_with_usage($type);
    }
    conf_template_filename = "" + TEMPLATE_DIR + "/_proxy.dev.conf";
  } else if ($type === 'static') {
    context['$basedir'] = argv._[2];
    if (context['$basedir'] == null) {
      end_with_usage($type);
    }
    conf_template_filename = "" + TEMPLATE_DIR + "/_static.dev.conf";
  } else {
    end_with_usage();
  }

  conf_template = fs.readFileSync(conf_template_filename).toString();

  conf_rendered = conf_template;

  for (key in context) {
    val = context[key];
    conf_rendered = conf_rendered.replace(RegExp("\\" + key, 'g'), val);
  }

  if (argv.o == null) {
    console.log(conf_rendered);
  } else {
    if (typeof argv.o === 'boolean') {
      conf_filename = "" + NGINX_CONF_DIR + "/ignitionx/" + context.$name + ".dev.conf";
    } else {
      conf_filename = argv.o;
    }
    if (argv.v != null) {
      console.log("[debug] Writing to " + conf_filename);
    }
    fs.writeFileSync(conf_filename, conf_rendered);
  }

}).call(this);
